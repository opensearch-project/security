/*
 * SPDX-License-Identifier: Apache-2.0
 *
 * The OpenSearch Contributors require contributions made to
 * this file be licensed under the Apache-2.0 license or a
 * compatible open source license.
 *
 * Modifications Copyright OpenSearch Contributors. See
 * GitHub history for details.
 */

// Uses Gradle to build RPMs since that's what we use for the other plugins. When all you have is a hammer...
plugins {
   id "nebula.ospackage" version "5.3.0"
}

// To prevent conflicts with maven build under build/
buildDir = 'gradle-build'

ext {
    opensearchVersion = '1.15.0'
    isSnapshot = "true" == System.getProperty("build.snapshot", "true")
}

group = "org.opensearch"
// Increment the final digit when there's a new plugin versions for the same opensearch version
// Reset the final digit to 0 when upgrading to a new opensearch version
version = "${opensearchVersion}.0" + (isSnapshot ? "-SNAPSHOT" : "")


if (!project.hasProperty("archivePath")) {
    throw new GradleException("Missing -ParchivePath command line switch pointing to built plugin ZIP")
}
if (!project.file(archivePath).exists()) {
    throw new GradleException("Missing plugin zip file: $archivePath")
}

ospackage {
    packageName = "opendistro-security"
    release = isSnapshot ? "0.1" : '1'
    version = "${project.version}"

    into '/usr/share/opensearch/plugins'
    from(zipTree(project.file(archivePath).absolutePath)) {
        into "opendistro_security"
        permissionGroup 'opensearch'
    }

    user 'root'
    permissionGroup 'root'

    requires('opensearch-oss', "7.10.3-SNAPSHOT", EQUAL)
    packager = 'Amazon'
    vendor = 'Amazon'
    os = 'LINUX'
    prefix '/usr'

    license 'ASL-2.0'
    maintainer 'OpenDistro for Elasticsearch Team <opendistro@amazon.com>'
    url 'https://opendistro.github.io/for-elasticsearch/downloads.html'
    summary '''
     Security plugin for OpenDistro for Elasticsearch. 
     Reference documentation can be found at https://opendistro.github.io/for-elasticsearch-docs/.
     '''.stripIndent().replace('\n', ' ').trim()

    //TODO: Would be better if the install_demo_configuration.sh script is marked executable in the upstream plugin instead of running bash manually here
    postInstall "exec /bin/bash /usr/share/opensearch/plugins/opendistro_security/tools/install_demo_configuration.sh -y -i -s"
}

buildRpm {
    arch = 'NOARCH'
    addParentDirs = false
    archiveName "${packageName}-${version}.rpm"
}

buildDeb {
    arch = 'all'
    archiveName "${packageName}-${version}.deb"
}
